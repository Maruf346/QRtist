{% extends 'base.html' %}

{% block title %}Generate QR Codes - QRtist{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section animate__animated animate__fadeIn">
    <div class="container position-relative">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <h1 class="display-3 fw-bold mb-4 animate__animated animate__fadeInUp">
                    Create Stunning <span class="text-warning">QR Codes</span> Instantly
                </h1>
                <p class="lead mb-4 opacity-75 animate__animated animate__fadeInUp animate__delay-1s">
                    Transform text, URLs, PDFs, and images into beautiful, customizable QR codes. 
                    Fast, free, and no registration required.
                </p>
                <div class="d-flex gap-3 animate__animated animate__fadeInUp animate__delay-2s">
                    <a href="#generator" class="btn btn-light btn-lg px-4 py-3">
                        <i class="fas fa-bolt me-2"></i> Start Creating
                    </a>
                    <a href="#features" class="btn btn-outline-light btn-lg px-4 py-3">
                        <i class="fas fa-star me-2"></i> Explore Features
                    </a>
                </div>
            </div>
            <div class="col-lg-6 text-center">
                <div class="floating-qr mt-5 mt-lg-0">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=QRtist%20is%20Awesome!&color=667eea&bgcolor=ffffff"
                         alt="QR Code Example" class="img-fluid rounded-3 shadow-lg" style="max-width: 250px;">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stats Section -->
<div class="container py-5">
    <div class="row g-4">
        <div class="col-md-3">
            <div class="stats-card text animate__animated animate__fadeInUp">
                <i class="fas fa-font fa-2x mb-3 text-primary"></i>
                <h2 class="text-primary">{{ stats.text }}</h2>
                <p class="text-muted mb-0">Text QR Codes</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card url animate__animated animate__fadeInUp animate__delay-1s">
                <i class="fas fa-link fa-2x mb-3 text-info"></i>
                <h2 class="text-info">{{ stats.url }}</h2>
                <p class="text-muted mb-0">URL QR Codes</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card pdf animate__animated animate__fadeInUp animate__delay-2s">
                <i class="fas fa-file-pdf fa-2x mb-3 text-danger"></i>
                <h2 class="text-danger">{{ stats.pdf }}</h2>
                <p class="text-muted mb-0">PDF QR Codes</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card image animate__animated animate__fadeInUp animate__delay-3s">
                <i class="fas fa-image fa-2x mb-3 text-warning"></i>
                <h2 class="text-warning">{{ stats.image }}</h2>
                <p class="text-muted mb-0">Image QR Codes</p>
            </div>
        </div>
    </div>
</div>

<!-- Generator Section -->
<div class="container py-5" id="generator">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="text-center mb-5">
                <h2 class="display-5 fw-bold mb-3">Create Your QR Code</h2>
                <p class="text-muted">Choose your content type and customize the appearance</p>
            </div>

            <!-- Tabs Navigation -->
            <ul class="nav nav-tabs nav-fill mb-4" id="qrTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="text-tab" data-bs-toggle="tab" data-bs-target="#text">
                        <i class="fas fa-font me-2"></i> Text
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="url-tab" data-bs-toggle="tab" data-bs-target="#url">
                        <i class="fas fa-link me-2"></i> URL
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pdf-tab" data-bs-toggle="tab" data-bs-target="#pdf">
                        <i class="fas fa-file-pdf me-2"></i> PDF
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="image-tab" data-bs-toggle="tab" data-bs-target="#image">
                        <i class="fas fa-image me-2"></i> Image
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="qrTabContent">
                <!-- Text Tab -->
                <div class="tab-pane fade show active" id="text" role="tabpanel">
                    <form id="textForm">
                        {% csrf_token %}
                        <div class="mb-4">
                            <label class="form-label fw-bold">Enter Text</label>
                            <textarea class="form-control" id="textInput" rows="5" 
                                      placeholder="Type or paste your text here..." 
                                      style="font-size: 1.1rem; padding: 1rem;"></textarea>
                            <div class="form-text mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Enter any text up to 2000 characters
                            </div>
                        </div>
                        {% include '_customization_options.html' %}
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                <i class="fas fa-magic me-2"></i> Generate QR Code
                            </button>
                        </div>
                    </form>
                </div>

                <!-- URL Tab -->
                <div class="tab-pane fade" id="url" role="tabpanel">
                    <form id="urlForm">
                        {% csrf_token %}
                        <div class="mb-4">
                            <label class="form-label fw-bold">Website URL</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-globe"></i>
                                </span>
                                <input type="url" class="form-control" id="urlInput" 
                                       placeholder="https://example.com"
                                       style="font-size: 1.1rem; padding: 1rem;">
                            </div>
                            <div class="form-text mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Enter a valid website URL
                            </div>
                        </div>
                        {% include '_customization_options.html' %}
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                <i class="fas fa-magic me-2"></i> Generate QR Code
                            </button>
                        </div>
                    </form>
                </div>

                <!-- PDF Tab -->
                <div class="tab-pane fade" id="pdf" role="tabpanel">
                    <form id="pdfForm" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-4">
                            <label class="form-label fw-bold">Upload PDF File</label>
                            <div class="file-upload-area">
                                <input type="file" class="form-control" id="pdfInput" accept=".pdf" 
                                       style="padding: 2rem; border-style: dashed; font-size: 1.1rem;">
                            </div>
                            <div class="form-text mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Maximum file size: 10MB • Supported: .pdf
                            </div>
                        </div>
                        {% include '_customization_options.html' %}
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                <i class="fas fa-magic me-2"></i> Generate QR Code
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Image Tab -->
                <div class="tab-pane fade" id="image" role="tabpanel">
                    <form id="imageForm" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-4">
                            <label class="form-label fw-bold">Upload Image</label>
                            <div class="file-upload-area">
                                <input type="file" class="form-control" id="imageInput" accept="image/*"
                                       style="padding: 2rem; border-style: dashed; font-size: 1.1rem;">
                            </div>
                            <div class="form-text mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Maximum file size: 10MB • Supported: JPG, PNG, GIF, BMP, WEBP
                            </div>
                        </div>
                        {% include '_customization_options.html' %}
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                <i class="fas fa-magic me-2"></i> Generate QR Code
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Section -->
<div class="container py-5">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="fas fa-eye me-2"></i>QR Code Preview</h4>
                        <span class="badge bg-primary">Live Preview</span>
                    </div>
                </div>
                <div class="card-body p-5">
                    <div class="qr-preview" id="qrPreview">
                        <div class="text-center">
                            <div class="mb-4">
                                <i class="fas fa-qrcode fa-4x text-muted mb-3"></i>
                                <h5 class="text-muted">Your QR Code Will Appear Here</h5>
                                <p class="text-muted mb-0">Generate a QR code to see the preview</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- QR Details (hidden initially) -->
                    <div id="qrDetails" class="mt-5" style="display: none;">
                        <hr>
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-3"><i class="fas fa-info-circle me-2"></i>QR Details</h5>
                                <div class="row">
                                    <div class="col-6 mb-3">
                                        <small class="text-muted d-block">QR ID</small>
                                        <span class="fw-bold" id="qrId">-</span>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <small class="text-muted d-block">Type</small>
                                        <span class="badge bg-primary" id="qrType">-</span>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <small class="text-muted d-block">Downloads</small>
                                        <span class="fw-bold">0</span>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <small class="text-muted d-block">Created</small>
                                        <span class="fw-bold" id="qrCreated">-</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 text-center">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success btn-lg" id="downloadBtn">
                                        <i class="fas fa-download me-2"></i> Download PNG
                                    </button>
                                    <a href="#" class="btn btn-outline-primary" id="viewDetailsBtn">
                                        <i class="fas fa-external-link-alt me-2"></i> View Details
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Features Section -->
<div class="container py-5" id="features">
    <div class="text-center mb-5">
        <h2 class="display-5 fw-bold mb-3">Why Choose QRtist?</h2>
        <p class="text-muted">Powerful features for all your QR code needs</p>
    </div>
    
    <div class="row g-4">
        <div class="col-md-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body p-4 text-center">
                    <div class="feature-icon mx-auto mb-4" style="background: var(--primary-gradient);">
                        <i class="fas fa-palette"></i>
                    </div>
                    <h4 class="mb-3">Beautiful Design</h4>
                    <p class="text-muted">
                        Customize colors, sizes, and styles to create QR codes that match your brand.
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body p-4 text-center">
                    <div class="feature-icon mx-auto mb-4" style="background: var(--secondary-gradient);">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <h4 class="mb-3">Instant Generation</h4>
                    <p class="text-muted">
                        Generate QR codes in seconds with our optimized processing engine.
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body p-4 text-center">
                    <div class="feature-icon mx-auto mb-4" style="background: var(--success-gradient);">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h4 class="mb-3">No Registration</h4>
                    <p class="text-muted">
                        Start creating immediately without any sign-up. Your data stays private.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent QR Codes -->
{% if recent_qrs %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">Recently Generated</h2>
        <a href="{% url 'history' %}" class="btn btn-outline-primary">
            <i class="fas fa-history me-2"></i> View All
        </a>
    </div>
    
    <div class="row g-4">
        {% for qr in recent_qrs %}
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <div class="text-center mb-3">
                        <img src="{{ qr.qr_image.url }}" alt="QR Code" 
                             class="img-fluid rounded-3 shadow" style="width: 120px; height: 120px;">
                    </div>
                    <h6 class="fw-bold mb-2">{{ qr.get_content_preview }}</h6>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="badge bg-{% if qr.content_type == 'text' %}primary{% elif qr.content_type == 'url' %}info{% elif qr.content_type == 'pdf' %}danger{% else %}warning{% endif %}">
                            {{ qr.content_type|upper }}
                        </span>
                        <small class="text-muted">{{ qr.created_at|timesince }} ago</small>
                    </div>
                    <div class="d-grid">
                        <a href="{% url 'download_qr' qr.id %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-download me-1"></i> Download
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- CTA Section -->
<div class="container py-5">
    <div class="card border-0 shadow-lg" style="background: var(--primary-gradient);">
        <div class="card-body p-5 text-center text-white">
            <h2 class="display-6 fw-bold mb-3">Ready to Create Amazing QR Codes?</h2>
            <p class="mb-4 opacity-75">Start generating beautiful QR codes for free today.</p>
            <a href="#generator" class="btn btn-light btn-lg px-5">
                <i class="fas fa-rocket me-2"></i> Get Started Now
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let currentQrId = '';
    let currentQrData = '';
    
    // Animate elements on scroll
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animate__animated', 'animate__fadeInUp');
            }
        });
    }, observerOptions);
    
    document.querySelectorAll('.stats-card, .card').forEach(card => {
        observer.observe(card);
    });
    
    // Enhanced form submission with loading states
    function showLoading(button) {
        const originalText = button.html();
        button.html(`
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Generating...
        `).prop('disabled', true);
        return originalText;
    }
    
    function hideLoading(button, originalText) {
        button.html(originalText).prop('disabled', false);
    }

    
    const CSRF_TOKEN = $('[name=csrfmiddlewaretoken]').val();

    
    // Handle text form submission
    $('#textForm').submit(function(e) {
        e.preventDefault();
        const formData = {
            text: $('#textInput').val(),
            size: parseInt($('#qrSize').val()),
            fill_color: $('#fillColor').val(),
            back_color: $('#backColor').val()
        };
        
        generateQR('/api/qr/text/', formData);
    });

    // Handle URL form submission
    $('#urlForm').submit(function(e) {
        e.preventDefault();
        const formData = {
            url: $('#urlInput').val(),
            size: parseInt($('#qrSize').val()),
            fill_color: $('#fillColor').val(),
            back_color: $('#backColor').val()
        };
        
        generateQR('/api/qr/url/', formData);
    });

    // Handle PDF form submission
    $('#pdfForm').submit(function(e) {
        e.preventDefault();
        const fileInput = $('#pdfInput')[0];
        
        if (!fileInput.files.length) {
            showAlert('Please select a PDF file', 'warning');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('size', $('#qrSize').val());
        
        generateFileQR('/api/qr/pdf/', formData);
    });

    // Handle image form submission
    $('#imageForm').submit(function(e) {
        e.preventDefault();
        const fileInput = $('#imageInput')[0];
        
        if (!fileInput.files.length) {
            showAlert('Please select an image file', 'warning');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('size', $('#qrSize').val());
        
        generateFileQR('/api/qr/image/', formData);
    });

    // Updated generateQR function for text/URL
    function generateQR(url, data) {
        $.ajax({
            url: url,
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': CSRF_TOKEN,
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                handleSuccessResponse(response);
            },
            error: function(xhr) {
                handleErrorResponse(xhr);
            }
        });
    }

    // New function for file uploads (PDF/Image)
    function generateFileQR(url, formData) {
        $.ajax({
            url: url,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': CSRF_TOKEN,
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                handleSuccessResponse(response);
            },
            error: function(xhr) {
                handleErrorResponse(xhr);
            }
        });
    }

    // Common success handler
    function handleSuccessResponse(response) {
        if (response.success) {
            // Store QR ID and data
            currentQrId = response.qr_id;
            currentQrData = response.qr_code;
            
            // Display QR code
            $('#qrPreview').html(`
                <div class="qr-result">
                    <img src="${response.qr_code}" class="img-fluid rounded-3 shadow" 
                        alt="Generated QR Code" style="max-width: 300px;">
                    <div class="mt-4">
                        <div class="alert alert-success" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            QR code generated successfully!
                        </div>
                    </div>
                </div>
            `);
            
            // Show QR details
            $('#qrId').text(response.qr_id);
            $('#qrType').text(response.content_type || 'Unknown');
            $('#qrContent').text(response.content);
            $('#qrCreated').text(new Date(response.created_at).toLocaleString());
            $('#viewDetailsBtn').attr('href', `/api/qr/${response.qr_id}/`);
            
            $('#qrDetails').slideDown();
            $('#downloadBtn').off('click').on('click', function() {
                window.location.href = `/download/${response.qr_id}/`;
            });
            
            // Show success notification
            Swal.fire({
                icon: 'success',
                title: 'QR Code Generated!',
                text: 'Your QR code is ready to download',
                timer: 3000,
                showConfirmButton: false,
                position: 'top-end',
                toast: true
            });
            
            // After successful QR generation, update recent QR codes without page reload
            function updateRecentQRCodes() {
                $.ajax({
                    url: '/api/qr/',  // Your API endpoint that returns recent QR codes
                    type: 'GET',
                    success: function(response) {
                        // Update the recent QR codes section
                        if (response.length > 0) {
                            let html = '';
                            response.slice(0, 5).forEach(qr => {
                                html += `
                                <div class="col-md-4 mb-3">
                                    <div class="d-flex align-items-center border rounded p-2">
                                        <div class="me-3">
                                            <img src="${qr.qr_image_url}" alt="QR Code" 
                                                class="img-thumbnail" style="width: 80px; height: 80px;">
                                        </div>
                                        <div>
                                            <h6 class="mb-1">${qr.content_preview}</h6>
                                            <p class="text-muted mb-1 small">
                                                ${qr.content_type} • ${new Date(qr.created_at).toLocaleTimeString()}
                                            </p>
                                            <button class="btn btn-sm btn-outline-primary download-recent-btn" 
                                                    data-id="${qr.id}">
                                                <i class="fas fa-download me-1"></i> Download
                                            </button>
                                        </div>
                                    </div>
                                </div>`;
                            });
                            
                            $('#recentQRCodesContainer').html(`
                                <div class="row">
                                    ${html}
                                </div>
                            `);
                            
                            // Add click handler for download buttons
                            $('.download-recent-btn').click(function() {
                                const qrId = $(this).data('id');
                                window.location.href = `/download/${qrId}/`;
                            });
                        }
                    },
                    error: function() {
                        console.log('Failed to update recent QR codes');
                    }
                });
            }
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: JSON.stringify(response.errors),
                confirmButtonColor: '#667eea'
            });
        }
    }

    // Common error handler
    function handleErrorResponse(xhr) {
        let errorMessage = 'Something went wrong. Please try again.';
        
        if (xhr.responseJSON && xhr.responseJSON.error) {
            errorMessage = xhr.responseJSON.error;
        } else if (xhr.status === 403) {
            errorMessage = 'CSRF verification failed. Please refresh the page.';
        } else if (xhr.status === 415) {
            errorMessage = 'Unsupported media type. Please check your request format.';
        } else if (xhr.status === 400) {
            errorMessage = 'Bad request. Please check your input.';
        }
        
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: errorMessage,
            confirmButtonColor: '#667eea'
        });
    }
    
    // Color picker enhancement
    $('.color-picker').on('change', function() {
        $(this).css('box-shadow', `0 0 0 3px ${$(this).val()}`);
    });
    
    // Initialize color pickers
    $('#fillColor, #backColor').trigger('change');
    
    // File input enhancement
    $('input[type="file"]').on('change', function(e) {
        const fileName = e.target.files[0]?.name || 'No file chosen';
        $(this).next('.custom-file-label').text(fileName);
        
        if (e.target.files[0]) {
            $(this).css({
                'border-color': '#667eea',
                'background-color': 'rgba(102, 126, 234, 0.05)'
            });
        }
    });
});
</script>
{% endblock %}